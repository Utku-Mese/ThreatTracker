<head>
    <style>
        body {
            margin: 0;
        }
    </style>

    <script src="//unpkg.com/d3-dsv"></script>
    <script src="//unpkg.com/index-array-by"></script>

    <script src="//unpkg.com/globe.gl"></script>
</head>

<body>
    <div id="globeViz"></div>

    <script>
        fetch('https://raw.githubusercontent.com/Utku-Mese/AtlasRota/main/data.json')
            .then(response => response.json())
            .then(jsonData => {
                const birdsData = jsonData.Birds.map(bird => ({
                    name: bird.Name,
                    lineColor: bird.Linecolor,
                    startPoint: { lat: bird.startPoint[0], lng: bird.startPoint[1] },
                    endPoint: { lat: bird.endPoint[0], lng: bird.endPoint[1] },
                    card: bird.Card,
                    visitedPlaces: bird.VisitedPlaces || [] 
                }));

                const myGlobe = Globe()
                    (document.getElementById('globeViz'))

                    .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
                    .pointOfView({ lat: 39.6, lng: -98.5, altitude: 2 }) // aim at continental US centroid

                    .arcLabel(d => `${d.name}: ${d.card.description}`)
                    .arcStartLat(d => +d.startPoint.lat)
                    .arcStartLng(d => +d.startPoint.lng)
                    .arcEndLat(d => +d.visitedPlaces[0]?.lat || d.endPoint.lat) // İlk ziyaret edilen yerin lat değeri yoksa, hedef noktanın lat değerini kullan
                    .arcEndLng(d => +d.visitedPlaces[0]?.lng || d.endPoint.lng) // İlk ziyaret edilen yerin lng değeri yoksa, hedef noktanın lng değerini kullan
                    .arcDashLength(0.75)
                    .arcDashGap(1)
                    .arcDashInitialGap(() => Math.random())
                    .arcDashAnimateTime(2000)
                    .arcColor(d => d.lineColor)
                    .arcsTransitionDuration(0)

                    .pointColor(() => 'orange')
                    .pointAltitude(0)
                    .pointRadius(0.02)
                    .pointsMerge(true);

                // load data
                myGlobe.arcsData(birdsData);

                // Add arcs for visited places and last visited place to end point
                birdsData.forEach(bird => {
                    bird.visitedPlaces.forEach((place, index) => {
                        if (index < bird.visitedPlaces.length - 1) {
                            myGlobe.arcsData([{
                                name: `${bird.name} Visited Place ${index}`,
                                lineColor: bird.lineColor,
                                startPoint: { lat: place.lat, lng: place.lng },
                                endPoint: { lat: bird.visitedPlaces[index + 1].lat, lng: bird.visitedPlaces[index + 1].lng },
                                card: bird.card
                            }]);
                        } else {
                            myGlobe.arcsData([{
                                name: `${bird.name} Last Visited Place`,
                                lineColor: bird.lineColor,
                                startPoint: { lat: place.lat, lng: place.lng },
                                endPoint: { lat: bird.endPoint[0], lng: bird.endPoint[1] },
                                card: bird.card
                            }]);
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Veri çekme hatası:', error);
            });
    </script>
</body>